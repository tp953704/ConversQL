<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>查詢分組發送器 (WebSocket版)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 200px; }
    button { margin-top: 10px; padding: 10px 20px; }
    #results { margin-top: 20px; white-space: pre-wrap; background: #f4f4f4; padding: 10px; border-radius: 5px; }
    .status { margin-top: 10px; padding: 5px; border-radius: 3px; }
    .connecting { background: #fff3cd; }
    .connected { background: #d4edda; }
    .disconnected { background: #f8d7da; }
  </style>
</head>
<body>
  <h2>請輸入資料</h2>
  <textarea id="inputBox" placeholder="貼上你的內容..."></textarea>
  <br>
  <button onclick="handleSubmit()">開始分組並送出</button>

  <div id="status" class="status disconnected">狀態: 未連接</div>

  <h3>回應結果：</h3>
  <div id="results"></div>

  <script>
    let socket = null;
    const statusElement = document.getElementById('status');
    let currentIndex = 0;
    let groups = [];
    // Connect when page loads
    window.addEventListener('load', () => {
      connectWebSocket();
    });

    function connectWebSocket() {
      socket = new WebSocket('wss://ollamaui.nexlumis.com/fubon/sql-checker/ws/ai/query');

      socket.onopen = () => {
        statusElement.textContent = '狀態: 已連接';
        statusElement.className = 'status connected';
      };

      socket.onclose = () => {
        statusElement.textContent = '狀態: 已斷開';
        statusElement.className = 'status disconnected';
        // Attempt to reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
      };

      socket.onerror = (error) => {
        statusElement.textContent = '狀態: 連接錯誤';
        statusElement.className = 'status disconnected';
      };

      socket.onmessage = (event) => {
        const resultDiv = document.getElementById('results');
        resultDiv.textContent += event.data + '\n\n';
        currentIndex++;
        if (currentIndex < groups.length) {
          const query = createQueryPayload(groups[currentIndex]);
          socket.send(query);
        }
      };
    }

    function parseGroups(text) {
      const lines = text.trim().split(/\r?\n/);
      const groups = [];
      let group = [];
      let selectCount = 0;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        group.push(line);

        if (/^select/i.test(line.trim())) {
          selectCount++;
        }

        if (selectCount === 2) {
          groups.push(group.join('\n'));
          group = [];
          selectCount = 0;
        }
      }

      if (group.length > 0) {
        groups.push(group.join('\n'));
      }

      return groups;
    }

    function createQueryPayload(query) {
      return `
        你是一個專業的SQL審查員，具有查詢資料庫DDL（數據定義語言）和當前DML（數據操作語言）狀態的能力。
        請根據以下提供的SQL腳本，逐步分析Step 2的執行語法（Execution Statement）是否存在問題。
        ### 分析流程
        步驟說明：
        1. 首先，你將獲得一個SQL腳本，格式如下：
        -- 人名1:人名2 需求
        -- Step 1:修改前查詢 (Before Update Query)
        [SELECT sql 語句]
        -- Step 2: 執行語法 (Execution Statement)
        [多個DELETE/INSERT/UPDATE sql 語句]
        -- Step 3: 修改後查詢 (After Update Query)
        [SELECT sql 語句]
        2. 你必須利用MCP能力（即查詢相關表的DDL和當前DML狀態）來輔助分析。
        3. 分析Step 2的執行語法，重點檢查以下兩類問題：
        a) 顯性失敗：執行時可能直接報錯  包含但不限於: 塞入的資料長度超過DDL規範, 非空欄位未塞入資料.....
        b) 隱藏性失敗：執行時不會報錯，但可能導致資料不正確 包含但不限於:可能更新多筆資料
        4. 分析過程中，請逐一檢查Step 2中的每一條語句
        5. 對於每一條Step2的語句，請給出：
        - 語句的潛在問題（顯性/隱藏性），若無問題則標記安全。
        - 若有問題，請說明原因，並盡可能提供修正建議。
        6. 所有 sql 語句中 DBUSERNEB. 皆可忽略 table name 也忽略它
        7. 部分 sql 語句 會用多行表示，請觀察分號位置
        請開始分析以下SQL腳本：
        ${query}
      `;
    }

    async function handleSubmit() {
      const input = document.getElementById('inputBox').value;
      const resultDiv = document.getElementById('results');
      resultDiv.textContent = "";
      groups = [];
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        resultDiv.textContent = '錯誤: WebSocket未連接';
        return;
      }

      resultDiv.textContent = '處理中...\n';

      const groups = parseGroups(input);
      currentIndex = 0;
      if (groups.length > 0) {
        try {
          console.log("ws connect");
          const query = createQueryPayload(group);
          socket.send(query);
          console.log("ws finish");
        } catch (error) {
          resultDiv.textContent += `錯誤處理：\n${group}\n錯誤：${error.message}\n\n`;
        }
      }
    }
  </script>
</body>
</html>